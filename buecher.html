<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leo's B√ºcher-Mediathek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dunkelblau-Grau */
            color: #e5e5e5;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.1), transparent 40%),
                        radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.1), transparent 40%);
            z-index: -1;
            animation: background-pan 30s linear infinite;
        }

        @keyframes background-pan {
          0% { background-position: 0% 0%; }
          100% { background-position: 100% 100%; }
        }

        #booksGrid {
            perspective: 2000px;
        }

        .storybook-card {
            position: relative;
            width: 250px;
            height: 350px;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6);
            border-radius: 8px 4px 4px 8px;
            padding: 0;
            transform-style: preserve-3d;
            transform: perspective(1000px) rotateY(0deg);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), inset 0 0 15px rgba(255,255,255,0.05);
            text-decoration: none;
            color: white;
            animation: float 6s ease-in-out infinite;
        }
        
        #booksGrid .storybook-card:nth-child(2n) {
            animation-delay: -3s;
        }

        .storybook-card:hover {
            transform: perspective(1000px) rotateY(-25deg) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), 0 0 30px rgba(59, 130, 246, 0.5);
            animation-play-state: paused;
        }
        
        .book-cover {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1.5rem;
            backface-visibility: hidden;
            transform: translateZ(1px);
        }

        /* Buchr√ºcken */
        .storybook-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -20px;
            width: 20px;
            height: 100%;
            background: linear-gradient(to right, #172554, #1e3a8a);
            transform-origin: left;
            transform: rotateY(90deg);
            border-radius: 4px 0 0 4px;
            box-shadow: inset 2px 0 5px rgba(0,0,0,0.3);
        }

        /* Seitenkanten */
        .storybook-card::after {
            content: '';
            position: absolute;
            top: 5px;
            right: -1px;
            bottom: 5px;
            width: 15px;
            background: linear-gradient(to right, #d1d5db, #f9fafb, #d1d5db);
            transform-origin: right;
            transform: rotateY(-90deg) translateZ(249px);
            box-shadow: inset -2px 0 4px rgba(0,0,0,0.1);
        }

        .storybook-card .emoji-container {
            font-size: 5rem;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 9999px;
            margin-bottom: 0;
        }
        
        .storybook-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .modal-backdrop { background-color: rgba(0,0,0,0.85); }
        .modal-content { background-color: #1f2937; }
        .admin-controls button { transition: background-color 0.2s; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

    </style>
</head>
<body class="min-h-screen">
    <header class="bg-gray-800 shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-white">üìö Leo's Mediathek</a>
            <div id="auth-controls">
                <a href="login.html" class="btn-primary text-sm font-semibold py-2 px-4 rounded-lg">Login</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Alle B√ºcher</h1>
            <div id="add-book-btn-container" class="hidden">
                 <button onclick="openModal()" class="btn-primary font-semibold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Neues Buch
                </button>
            </div>
        </div>

        <div id="booksGrid" class="flex flex-wrap justify-center gap-8">
            <!-- B√ºcher werden hier per JS geladen -->
        </div>
    </main>

    <!-- Modal f√ºr Hinzuf√ºgen/Bearbeiten -->
    <div id="bookModal" class="fixed inset-0 modal-backdrop items-center justify-center p-4 hidden z-50">
        <div class="modal-content w-full max-w-lg rounded-lg shadow-xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="modalTitle" class="text-2xl font-bold">Neues Buch hinzuf√ºgen</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="mb-4">
                        <label for="bookTitle" class="block text-sm font-medium text-gray-300 mb-1">Titel</label>
                        <input type="text" id="bookTitle" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="bookEmoji" class="block text-sm font-medium text-gray-300 mb-1">Emoji / Icon</label>
                        <input type="text" id="bookEmoji" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="bookLink" class="block text-sm font-medium text-gray-300 mb-1">Gemini Story Link</label>
                        <input type="url" id="bookLink" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-800 text-right space-x-2">
                <button onclick="closeModal()" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                <button onclick="handleFormSubmit()" class="btn-primary font-semibold py-2 px-4 rounded-lg">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        const booksGrid = document.getElementById('booksGrid');
        const bookModal = document.getElementById('bookModal');
        const modalTitle = document.getElementById('modalTitle');
        const bookForm = document.getElementById('bookForm');
        const authControls = document.getElementById('auth-controls');
        const addBookBtnContainer = document.getElementById('add-book-btn-container');

        let allBooks = [];
        let loggedIn = false;

        async function fetchBooks() {
            try {
                const response = await fetch('./api/api.php');
                if (!response.ok) throw new Error('Netzwerk-Antwort war nicht ok.');
                const books = await response.json();
                allBooks = books;
                renderBooks(allBooks);
            } catch (error) {
                booksGrid.innerHTML = `<p class="text-red-400 col-span-full text-center">Fehler beim Laden der B√ºcher. √úberpr√ºfe die API-Verbindung und die Datenbank.</p>`;
                console.error("Fehler:", error);
            }
        }

        function renderBooks(books) {
            booksGrid.innerHTML = '';
            if (books.length === 0) {
                 booksGrid.innerHTML = `<p class="text-gray-400 col-span-full text-center">Noch keine B√ºcher vorhanden.</p>`;
                 return;
            }

            books.forEach(book => {
                const card = document.createElement('a');
                
                let rawLink = book.link || '#';
                let cleanLink = rawLink;

                const markdownMatch = rawLink.match(/\((https?:\/\/[^\s)]+)\)/);
                if (markdownMatch && markdownMatch[1]) {
                    cleanLink = markdownMatch[1];
                }

                card.href = cleanLink;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.className = 'storybook-card';
                
                let adminControlsHTML = '';
                if(loggedIn) {
                    adminControlsHTML = `
                    <div class="admin-controls absolute top-2 right-2 flex gap-2" style="transform: translateZ(2px);">
                        <button onclick="event.preventDefault(); event.stopPropagation(); deleteBook(${book.id})" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <button onclick="event.preventDefault(); event.stopPropagation(); openModal(allBooks.find(b => b.id === ${book.id}))" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        </button>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="book-cover">
                        <div class="emoji-container">${book.emoji}</div>
                        <h3>${book.title}</h3>
                    </div>
                    ${adminControlsHTML}
                `;

                booksGrid.appendChild(card);
            });
        }
        
        // --- Modal Logic ---
        function openModal(book = null) {
            bookForm.reset();
            if (book) {
                modalTitle.textContent = 'Buch bearbeiten';
                document.getElementById('bookId').value = book.id;
                document.getElementById('bookTitle').value = book.title;
                document.getElementById('bookEmoji').value = book.emoji;
                document.getElementById('bookLink').value = book.link;
            } else {
                modalTitle.textContent = 'Neues Buch hinzuf√ºgen';
            }
            bookModal.classList.remove('hidden');
            bookModal.classList.add('flex');
        }

        function closeModal() {
            bookModal.classList.add('hidden');
            bookModal.classList.remove('flex');
        }
        
        async function handleFormSubmit() {
            const bookId = document.getElementById('bookId').value;
            const bookData = {
                title: document.getElementById('bookTitle').value,
                emoji: document.getElementById('bookEmoji').value,
                link: document.getElementById('bookLink').value,
            };

            const method = bookId ? 'PUT' : 'POST';
            if(bookId) bookData.id = bookId;

            try {
                const response = await fetch('./api/api.php', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookData)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    closeModal();
                    fetchBooks();
                } else {
                    alert('Fehler: ' + result.message);
                }
            } catch (error) {
                alert('Ein Fehler ist aufgetreten.');
                console.error(error);
            }
        }
        
        async function deleteBook(id) {
            if (!confirm('Bist du sicher, dass du dieses Buch l√∂schen m√∂chtest?')) return;

            try {
                const response = await fetch('./api/api.php', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                 const result = await response.json();
                if (result.status === 'success') {
                    fetchBooks();
                } else {
                    alert('Fehler beim L√∂schen: ' + result.message);
                }
            } catch (error) {
                 alert('Ein Fehler ist aufgetreten.');
                 console.error(error);
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch('./api/check_login.php');
                const data = await response.json();
                loggedIn = data.loggedIn;
            } catch(e) {
                loggedIn = false;
            }
            
            if(loggedIn) {
                 authControls.innerHTML = `<button onclick="logout()" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Logout</button>`;
                 addBookBtnContainer.classList.remove('hidden');
            } else {
                 authControls.innerHTML = `<a href="login.html" class="btn-primary text-sm font-semibold py-2 px-4 rounded-lg">Login</a>`;
                 addBookBtnContainer.classList.add('hidden');
            }
            fetchBooks(); // rendert die B√ºcher neu mit/ohne Admin-Controls
        }

        async function logout() {
            await fetch('./api/logout.php');
            loggedIn = false;
            checkLoginStatus();
        }

        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>