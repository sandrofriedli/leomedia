<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leo's Video-Mediathek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(236, 72, 153, 0.1), transparent 40%),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.1), transparent 40%);
            z-index: -1;
            animation: background-pan 30s linear infinite;
        }

        @keyframes background-pan {
          0% { background-position: 0% 0%; }
          100% { background-position: 100% 100%; }
        }

        .video-card {
            position: relative;
            background-color: #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            animation: float 7s ease-in-out infinite;
            cursor: pointer;
        }

        #videosGrid .video-card:nth-child(2n) {
            animation-delay: -3.5s;
        }

        .video-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 30px rgba(0,0,0,0.4), 0 0 30px rgba(59, 130, 246, 0.4);
            animation-play-state: paused;
        }

        .video-card img {
            transition: transform 0.4s ease;
            width: 100%;
            height: auto;
            object-fit: cover;
            aspect-ratio: 2/3;
            background-color: #374151;
        }
        
        .video-card .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            aspect-ratio: 2/3;
            background-color: #374151;
            font-size: 1.5rem;
            text-align: center;
            padding: 1rem;
            transition: transform 0.4s ease;
        }
        .video-card:hover .placeholder {
            transform: scale(1.1);
        }

        .video-card:hover img {
            transform: scale(1.1);
        }

        .video-card .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(31, 41, 55, 0.95) 20%, transparent 100%);
            padding: 2rem 1rem 1rem 1rem;
            text-align: left;
        }
        
        .platform-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(5px);
            color: #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .modal-backdrop { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .modal-content { background-color: #1f2937; }
        .admin-controls button { transition: background-color 0.2s; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-gray-800 shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-white">🎬 Leo's Mediathek</a>
            <div id="auth-controls">
                <a href="login.html?redirect=videos.html" class="btn-primary text-sm font-semibold py-2 px-4 rounded-lg">Login</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Alle Videos</h1>
            <div id="add-video-btn-container" class="hidden">
                 <button onclick="openFormModal()" class="btn-primary font-semibold py-2 px-4 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    Neues Video
                </button>
            </div>
        </div>

        <div id="videosGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- Video-Karten werden hier per JS eingefügt -->
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 modal-backdrop items-center justify-center p-4 hidden z-50">
        <div class="modal-content w-full max-w-3xl rounded-lg shadow-xl overflow-hidden relative">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl z-10">&times;</button>
            <div id="detailModalContent" class="max-h-[90vh] overflow-y-auto">
                <!-- Inhalt wird per JS geladen -->
            </div>
        </div>
    </div>


    <!-- Formular Modal für Hinzufügen/Bearbeiten -->
    <div id="formModal" class="fixed inset-0 modal-backdrop items-center justify-center p-4 hidden z-50">
        <div class="modal-content w-full max-w-lg rounded-lg shadow-xl overflow-hidden">
            <form id="videoForm" class="w-full">
                <input type="hidden" id="videoId" name="id">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 id="formModalTitle" class="text-2xl font-bold">Neues Video</h2>
                    <button type="button" onclick="closeFormModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="videoTitle" class="block text-sm font-medium text-gray-300 mb-1">Titel</label>
                            <input type="text" id="videoTitle" name="title" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" required>
                        </div>
                        <div>
                             <label for="posterUrl" class="block text-sm font-medium text-gray-300 mb-1">Poster URL</label>
                            <input type="url" id="posterUrl" name="posterUrl" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" required>
                        </div>
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-300 mb-1">Alter</label>
                            <select id="age" name="age" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" required>
                                <option value="0">Ab 0</option><option value="2">Ab 2</option><option value="3">Ab 3</option><option value="6">Ab 6</option>
                            </select>
                        </div>
                        <div>
                            <label for="platform" class="block text-sm font-medium text-gray-300 mb-1">Plattform</label>
                            <input type="text" id="platform" name="platform" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="z.B. YouTube, KIKA">
                        </div>
                         <div>
                            <label for="firstAired" class="block text-sm font-medium text-gray-300 mb-1">Erstausstrahlung</label>
                            <input type="text" id="firstAired" name="firstAired" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="z.B. 2018">
                        </div>
                        <div>
                            <label for="imdbRating" class="block text-sm font-medium text-gray-300 mb-1">IMDb Rating</label>
                            <input type="text" id="imdbRating" name="imdbRating" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="z.B. 8.5">
                        </div>
                        <div class="md:col-span-2">
                             <label for="tags" class="block text-sm font-medium text-gray-300 mb-1">Tags (kommagetrennt)</label>
                            <input type="text" id="tags" name="tags" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="z.B. Tiere, Abenteuer">
                        </div>
                         <div class="md:col-span-2">
                            <label for="summary" class="block text-sm font-medium text-gray-300 mb-1">Zusammenfassung</label>
                            <textarea id="summary" name="summary" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"></textarea>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-800 text-right space-x-2">
                    <button type="button" onclick="closeFormModal()" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                    <button type="submit" class="btn-primary font-semibold py-2 px-4 rounded-lg">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const videosGrid = document.getElementById('videosGrid');
        const formModal = document.getElementById('formModal');
        const detailModal = document.getElementById('detailModal');
        const detailModalContent = document.getElementById('detailModalContent');
        const formModalTitle = document.getElementById('formModalTitle');
        const videoForm = document.getElementById('videoForm');
        const authControls = document.getElementById('auth-controls');
        const addVideoBtnContainer = document.getElementById('add-video-btn-container');

        let allVideos = [];
        let loggedIn = false;

        async function fetchVideos() {
            try {
                const response = await fetch('./api/videos_api.php');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Netzwerk-Antwort war nicht ok.');
                }
                const videos = await response.json();
                allVideos = videos;
                renderVideos(allVideos);
            } catch (error) {
                videosGrid.innerHTML = `<p class="text-red-400 col-span-full text-center">Fehler beim Laden der Videos. Überprüfe die API-Verbindung und die Datenbank-Struktur. Details: ${error.message}</p>`;
            }
        }

        function renderVideos(videos) {
            videosGrid.innerHTML = '';
            if (!videos || videos.length === 0) {
                 videosGrid.innerHTML = `<p class="text-gray-400 col-span-full text-center">Noch keine Videos vorhanden.</p>`;
                 return;
            }

            videos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => openDetailModal(video);
                
                let adminControlsHTML = '';
                if(loggedIn) {
                    adminControlsHTML = `
                    <div class="admin-controls absolute top-2 right-2 flex gap-2 z-10">
                        <button onclick="event.stopPropagation(); deleteVideo(${video.id})" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <button onclick="event.stopPropagation(); openFormModal(video)" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center shadow-lg">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        </button>
                    </div>`;
                }
                
                let imageOrFallback = video.posterUrl ? `<img src="${video.posterUrl}" alt="Poster von ${video.title}" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\'placeholder\'>${video.title}</div>';">` : `<div class='placeholder'>${video.title}</div>`;

                card.innerHTML = `
                    ${imageOrFallback}
                    <div class="overlay">
                        <h3 class="text-md font-semibold truncate text-white" title="${video.title}">${video.title}</h3>
                        <p class="text-xs text-gray-400">Ab ${video.age} J.</p>
                    </div>
                    ${video.platform ? `<div class="platform-badge">${video.platform}</div>` : ''}
                    ${adminControlsHTML}
                `;

                videosGrid.appendChild(card);
            });
        }
        
        // --- Formular Modal ---
        function openFormModal(video = null) {
            videoForm.reset();
            if (video) {
                formModalTitle.textContent = 'Video bearbeiten';
                document.getElementById('videoId').value = video.id;
                document.getElementById('videoTitle').value = video.title;
                document.getElementById('posterUrl').value = video.posterUrl;
                document.getElementById('age').value = video.age;
                document.getElementById('platform').value = video.platform;
                document.getElementById('firstAired').value = video.firstAired;
                document.getElementById('imdbRating').value = video.imdbRating;
                document.getElementById('tags').value = video.tags;
                document.getElementById('summary').value = video.summary;
            } else {
                formModalTitle.textContent = 'Neues Video hinzufügen';
            }
            formModal.classList.remove('hidden');
            formModal.classList.add('flex');
        }
        function closeFormModal() {
            formModal.classList.add('hidden');
            formModal.classList.remove('flex');
        }

        // --- Detail Modal ---
        function openDetailModal(video) {
            let imageOrFallback = video.posterUrl ? `<img src="${video.posterUrl}" alt="Poster von ${video.title}" class="w-full h-auto rounded-lg shadow-lg" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\'placeholder text-xl\'>${video.title}</div>';">` : `<div class='placeholder text-xl'>${video.title}</div>`;
            detailModalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        ${imageOrFallback}
                    </div>
                    <div class="md:col-span-2 p-4">
                        <h2 class="text-3xl font-bold text-white mb-2">${video.title}</h2>
                        <div class="flex items-center gap-4 text-gray-400 mb-4">
                            ${video.firstAired ? `<span>🗓️ ${video.firstAired}</span>` : ''}
                            ${video.imdbRating ? `<span>⭐ ${video.imdbRating} / 10</span>` : ''}
                            <span>Ab ${video.age} J.</span>
                        </div>
                        <p class="text-gray-300 mb-6">${video.summary || 'Keine Beschreibung verfuegbar.'}</p>
                        ${video.tags ? `<div class="mb-6 flex flex-wrap gap-2">${video.tags.split(',').map(tag => `<span class="bg-gray-700 text-gray-300 text-xs font-medium px-2.5 py-1 rounded-full">${tag.trim()}</span>`).join('')}</div>` : ''}
                    </div>
                </div>
            `;
            detailModal.classList.remove('hidden');
            detailModal.classList.add('flex');
        }
        function closeDetailModal() {
            detailModal.classList.add('hidden');
            detailModal.classList.remove('flex');
        }


        videoForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(videoForm);
            const id = formData.get('id');
            
            if (id) {
                formData.append('_method', 'PUT');
            }

            try {
                const response = await fetch('./api/videos_api.php', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'success') {
                    closeFormModal();
                    fetchVideos();
                } else {
                    alert('Fehler: ' + result.message);
                }
            } catch (error) {
                alert('Ein Fehler ist aufgetreten.');
            }
        });
        
        async function deleteVideo(id) {
            if (!confirm('Bist du sicher, dass du dieses Video loeschen moechtest?')) return;
            try {
                const response = await fetch(`./api/videos_api.php?id=${id}`, { method: 'DELETE' });
                 const result = await response.json();
                if (result.status === 'success') {
                    fetchVideos();
                } else {
                    alert('Fehler beim Loeschen: ' + result.message);
                }
            } catch (error) {
                 alert('Ein Fehler ist aufgetreten.');
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch('./api/check_login.php');
                const data = await response.json();
                loggedIn = data.loggedIn;
            } catch(e) { loggedIn = false; }
            
            if(loggedIn) {
                 authControls.innerHTML = `<button onclick="logout()" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg">Logout</button>`;
                 addVideoBtnContainer.classList.remove('hidden');
            } else {
                 authControls.innerHTML = `<a href="login.html?redirect=videos.html" class="btn-primary text-sm font-semibold py-2 px-4 rounded-lg">Login</a>`;
                 addVideoBtnContainer.classList.add('hidden');
            }
            fetchVideos();
        }

        async function logout() {
            await fetch('./api/logout.php');
            loggedIn = false;
            window.location.reload();
        }

        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>
